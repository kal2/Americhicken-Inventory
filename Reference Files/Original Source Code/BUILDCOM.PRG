**********
* Program.: BUILDCOM.PRG
* Author..: Grace Keller
* Date....: 01/11/88
* Notice..: Copyright 1988, Solid Software, Inc., All Rights Reserved
* Version.: FOXPRO
* Notes...: BUILD FOR MIDWEST SALESPERSONS COMMISSIONS
*
* ---OPEN FILES
*  MULTI-USER RECORD/FILE LOCKING  +(M1)  FoxPro   Multi-User Code Insertion     

MTITLE = " - APPROVE MIDWEST COMMISSIONS FOR PAYMENT"
CLEAR
@  1, 1  SAY MCOMPANY
@  1,68 SAY DATE()
@  2, 0 SAY MPROGRAM + MTITLE
@ 3,0 to 24,79
@ 10,5 say 'STEP 1.'
store ' ' to mwait
@ 12,5 SAY 'This step will print a report of invoices on file that '
@ 13,5 say 'are not marked paid in full - but have a zero balance.'
@ 14,5 say 'Press return when ready to continue. ' get mwait
READ

MPRT_ACT = 'C'

DO PRT_SET

IF MPRT_ACT <> 'C'
   RETURN
ENDIF
MPAGE_LEN = 56

MPAGE_NO = 0
MLINE = 99 
@ 19,16 SAY 'PROCESSING... PLEASE WAIT.....'

SET CONSOLE OFF
IF FILE("C:\COMPINFO\PRINTERS.DBF")
   SET PRINT TO C:\COMPINFO\PRT_FILE.TXT
ELSE
   SET PRINT TO LPT3
ENDIF
SET DEVICE TO PRINT
SET PRINT ON

*** PRINT IN 10 CPI
?? chr(27) + '&k0S'

*** LETTER GOTHIC AND BOLDED PRINT
?? chr(27) + '(s4102T' + chr(27) + '(s3B' + chr(27) + '(s3B'

*** LETTER SIZE PAPER
?? CHR(27) + '&l2A'

*** PORTRAIT MODE
?? CHR(27) + '&l0O'

SELECT C
DO FOX_USE WITH "&MDBFLOC.BIL_BUY INDEX &MDBFLOC.BBUYCODE", .F.
*** HAVE TO TAKE A LOOK AT TWO DATABASES
MDATABASE = 1   
DO WHILE MDATABASE <= 2
   DO CASE
   CASE MDATABASE = 1
      SELECT D
      DO FOX_USE WITH "PO_HEAD INDEX PO_HEAD", .F.
      SELECT B
      DO FOX_USE WITH "INV_ADJ INDEX INV_ADJ", .F.
      SELECT A
      DO FOX_USE WITH "CUS_INV INDEX CUS_DATE, CUS_INV, CUSIVNBR", .F.
   OTHERWISE            
      SELECT D
      DO FOX_USE WITH "L:PO_HEAD INDEX L:PO_HEAD", .F.
      SELECT B
      DO FOX_USE WITH "L:INV_ADJ INDEX L:INV_ADJ", .F.
      SELECT A
      DO FOX_USE WITH "L:CUS_INV INDEX L:CUS_DATE, L:CUS_INV, L:CUSIVNBR", .F.
   ENDCASE
   
   SEEK ' '
   DO WHILE .NOT. EOF() .AND. PAID_FLG = ' '
      *** ONLY LOOK AT INVOICES
      IF SUBSTR(INV_NBR,1,1) = 'A' .OR. DEB_CRD <> ' '
         SKIP
         LOOP
      ENDIF
      MADJ_TOT = 0
      SELECT B
      SEEK A->INV_NBR
      DO WHILE .NOT. EOF() .AND. INV_NBR = A->INV_NBR
         MADJ_TOT = MADJ_TOT + ADJ_AMT
         SKIP
      ENDDO
      SELECT A
      MTOT_SELL = TOT_SELL + CUS_PALL + MADJ_TOT
      
      IF MTOT_SELL - AMT_PAID = 0
         IF MLINE > MPAGE_LEN
            IF MLINE <> 99
               EJECT
            ENDIF
            MPAGE_NO = MPAGE_NO + 1
            @ 1,34 SAY MCOMPANY
            @ 2,0 SAY 'PAGE'
            @ 2,05 say mpage_no picture '99'
            @ 2,15 SAY 'INVOICES WITH ZERO BALANCE - NOT MARKED PAID IN FULL'
            @ 2,70 SAY DTOC(DATE())
            @ 4,5 SAY 'INV NBR'
            @ 4,17 SAY 'PO NBR'
            @ 4,30 SAY 'CUSTOMER'
            @ 4,0 SAY REPLICATE ('_',80)
            MLINE = 6
         ENDIF
         IF SALESMAN <> '  '
            @ MLINE,5 SAY SALESMAN + '-'
         ENDIF
         @ MLINE,8 SAY INV_NBR
         IF SALESMAN <> ' '
            @ MLINE,17 SAY SALESMAN + '-'
         ENDIF
         @ MLINE,20 SAY PO_NBR
         IF PO_SUFFIX <> ' '
            @ MLINE,24 SAY '-' + PO_SUFFIX
         ENDIF
         SELECT C
         SEEK A->BBUYCODE
         IF EOF()
            STORE 'CUSTOMER NOT ON FILE' TO MNAME
         ELSE
            STORE NAME TO MNAME
         ENDIF
         @ MLINE,30 SAY MNAME
         MLINE = MLINE + 2
         ***** THIS WOULD MARK THEM PAID IN FULL
         *            SKIP -1
         *            STORE RECNO() TO MRECNO
         *            SKIP
         *            REPLACE PAID_FLG WITH 'Y'
         *            GOTO RECNO
         SELECT A
      ENDIF
      SKIP
   ENDDO
   MDATABASE = MDATABASE + 1
ENDDO

IF MLINE = 99 
   IF MLINE > MPAGE_LEN
      IF MLINE <> 99
         EJECT
      ENDIF
      MPAGE_NO = MPAGE_NO + 1
      @ 1,34 SAY MCOMPANY
      @ 2,0 SAY 'PAGE'
      @ 2,05 say mpage_no picture '99'
      @ 2,15 SAY 'INVOICES WITH ZERO BALANCE - NOT MARKED PAID IN FULL'
      @ 2,70 SAY DTOC(DATE())
      @ 4,5 SAY 'INV NBR'
      @ 4,17 SAY 'PO NBR'
      @ 4,30 SAY 'CUSTOMER'
      @ 4,0 SAY REPLICATE ('_',80)
      MLINE = 6
   ENDIF
   @ MLINE,5 SAY 'NO INVOICES ON FILE WITH ZERO BALANCE.'
ENDIF
EJECT
SET DEVICE TO SCREEN
SET PRINT OFF
SET PRINT TO
SET CONSOLE ON
IF MPRINTER3 <> 'DONOTPRINT'
   RUN &MPRINTIT3
ENDIF

CLOSE DATA
@ 4,1 CLEAR TO 22,78
STORE 'N' TO MYES_NO
@ 10,5 SAY 'DO YOU WANT TO CONTINUE WITH THE APPROVAL STEP (Y/N) ? ' GET MYES_NO PICTURE '@!'
READ
IF MYES_NO <> 'Y'
   RETURN
ENDIF

**** CONTINUE ON HERE WITH APPROVAL PROCESS
SELECT E
DO FOX_USE WITH "SALESMAN INDEX SAL_CODE", .F.

SELECT B
DO FOX_USE WITH "PO_HEAD INDEX PO_HEAD", .F.

SELECT D
DO FOX_USE WITH "CUS_INV INDEX CUSIVNBR", .F.

SELECT C
DO FOX_USE WITH "&MMASTDBF.COMLED INDEX &MMASTDBF.COMPD", .F.
DO FILELOCK
REPLACE ALL APRVD_FLG WITH ' ' FOR COM_PD = ' ' .and. COM_TYPE = 'S'
UNLOCK

SEEK ' S'
@ 10,10 SAY 'STEP 2.'
@ 12,10 SAY 'PROCESSING APPROVALS.......PLEASE WAIT...'

DO WHILE .NOT. EOF() .AND. COM_PD = ' ' .AND. COM_TYPE = 'S'
   STORE SALESMAN TO MSALESMAN
   SELECT E
   SEEK MSALESMAN
   SELECT C
   ** IF THE SALESMAN FILE SAYS TO SKIP APPROVING THIS PERSON
   ** SKIP AROUND ALL OF THEM
   IF E->APRV_COM = 'N'
      DO WHILE .NOT. EOF() .AND. COM_TYPE = 'S' .AND. MSALESMAN = COM_CODE
         SKIP
      ENDDO
      LOOP
   ENDIF
   
   DO WHILE COM_PD = ' ' .AND. COM_TYPE = 'S' .AND. MSALESMAN = COM_CODE
      STORE PO_NBR TO MPO_NBR
      STORE PO_SUFFIX TO MPO_SUFFIX
      IF INV_NBR = SPACE(5)
         MINV_NBR = SPACE(5)
         SELECT B
         IF MSALESMAN = '72'
            DO FOX_USE WITH "L:PO_HEAD INDEX L:PO_HEAD", .F.
         ELSE
            DO FOX_USE WITH "&MMASTDBF.PO_HEAD INDEX &MMASTDBF.PO_HEAD", .F.
         ENDIF
         SEEK MSALESMAN + MPO_NBR + MPO_SUFFIX
         IF .NOT. EOF()
            STORE INV_NBR TO MINV_NBR
            SELECT C
            DO RECLOCK
            REPLACE INV_NBR WITH MINV_NBR
            UNLOCK
         ENDIF
      ENDIF
      MPAID = .T.
      SELECT D
      IF MSALESMAN = '72'
         DO FOX_USE WITH "L:CUS_INV INDEX L:CUSIVNBR", .F.
      ELSE
         DO FOX_USE WITH "&MMASTDBF.CUS_INV INDEX &MMASTDBF.CUSIVNBR", .F.
      ENDIF
      SEEK C->INV_NBR
      IF .NOT. EOF()
         IF PAID_FLG = ' '
            MPAID = .F.
         ENDIF
      ENDIF
      SELECT C
      IF MPAID
         DO RECLOCK
         REPLACE APRVD_FLG WITH 'Y'    
         UNLOCK
      ENDIF
      SKIP
   ENDDO
ENDDO
CLOSE DATA
RETURN
* EOF: BUILDCOM.PRG

*Formatted by: ToolBox Ver. 1.2  on 7/22/14 at 2:30 PM.
