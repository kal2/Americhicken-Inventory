**************************
*  FILE NAME: ALLAGE.PRG
*  DATE: 5/31/95
CLEAR
@ 01,00 SAY MCOMPANY
@ 02,00 SAY MPROGRAM + ' - CALCULATE AGING BETWEEN TWO DATES'
@ 02,70 SAY DATE()
@ 3,0 to 24,79
MSALESMAN = '**'
STORE CTOD('') TO MBEGIN, MEND
STORE 2 TO MACTION      
DO WHILE MACTION = 2      
   @ 08,2 SAY 'Enter Optional Salesperson Code: '
   @ 08,37 get msalesman
   @ 10,2 say 'Beginning Ship Date: '     
   @ 10,23 GET MBEGIN 
   @ 12,2 SAY '   Ending Ship Date: '
   @ 12,23 GET MEND 
   STORE 1 TO MACTION
   @ 24,00 CLEAR
   @ 24,01 SAY 'Action: ' + STR(MACTION,1)
   @ 24,13 SAY '1. Continue    2.  Edit    3. Cancel Report'                     
   
   READ
   
   @24,09 GET MACTION PICTURE '9' RANGE 1,3
   READ               
   IF MACTION = 1
      IF DTOC(MBEGIN) = '  /  /  ' .AND. DTOC(MEND) = '  /  /  '
         MACTION = 3
         LOOP
      ENDIF
      IF (DTOC(MBEGIN) <> '  /  /  ' .AND. DTOC(MEND) = '  /  /  ') .OR. (DTOC(MBEGIN) = '  /  /  ' .AND. DTOC(MEND) <> '  /  /  ')
         @ 24,0 CLEAR
         mwait = ' '
         @ 24,1 SAY 'Only One Date Entered - Both Begin and End Dates Must be Entered ' GET MWAIT
         READ
         MACTION = 2
         @ 24,0 clear
         LOOP 
      ENDIF
   ENDIF
ENDDO
IF MACTION = 3
   RETURN 
ENDIF  
MPRT_ACT = 'C'

DO PRT_SET
IF MPRT_ACT <> 'C'
   RETURN
ENDIF
MPAGE_LEN = 56

STORE MONTH(MBEGIN) TO MMONTH
MMONTH = MMONTH + 100
STORE SUBSTR(STR(MMONTH,3),2) TO MMONTH

STORE YEAR(MBEGIN) TO MYEAR
STORE STR(MYEAR,4) TO MYEAR

SELECT A
DO FOX_USE WITH "&MDBFLOC.BIL_BUY INDEX &MDBFLOC.BBUYCODE", .F.
@ 4,1 CLEAR TO 20,78
@ 17,03 SAY 'CALCULATING CUSTOMER AGING FOR SELECTED TIME PERIOD - PLEASE WAIT...'

DO WHILE .NOT. EOF()
   DO RECLOCK
   REPLACE WORKSHIPS WITH 0
   REPLACE WORKDAYS WITH 0
   UNLOCK
   SKIP
ENDDO

SELECT B
DO FOX_USE WITH "PO_HEAD INDEX PO_SHIP", .F.

SELECT C
DO FOX_USE WITH "PAYMENTS INDEX PAY_PO", .F.

SELECT B
SEEK MYEAR + MMONTH
DO WHILE .NOT. EOF() .AND. SHIP_DATE <= MEND     
   IF MSALESMAN <> '**'
      IF SALESMAN <> MSALESMAN
         SKIP
         LOOP
      ENDIF
   ENDIF
   MCUST = .F.
   IF SALESMAN = '66'
      DO CASE
      CASE BBUYCODE = '  31' .OR. BBUYCODE = ' 566' .OR. BBUYCODE = ' 744'
          MCUST = .T.
      CASE BBUYCODE = ' 268' .OR. BBUYCODE = ' 810' .OR. BBUYCODE = '  64'
          MCUST = .T.
      ENDCASE
   ENDIF   

   IF MCUST
      SKIP
      LOOP
   ENDIF

   STORE BBUYCODE TO MBBUYCODE
   IF SHIP_DATE < MBEGIN     
      SKIP
      LOOP
   ENDIF
   SELECT C
   SEEK B->SALESMAN + B->PO_NBR + B->PO_SUFFIX
   IF .NOT. EOF()
      MDAYS = (PAID_DATE - B->SHIP_DATE)
      SELECT A
      SEEK MBBUYCODE
      IF .NOT. EOF()
         DO RECLOCK
         REPLACE WORKSHIPS WITH WORKSHIPS + 1
         REPLACE WORKDAYS WITH WORKDAYS + MDAYS
         UNLOCK
      ENDIF
   ENDIF
   SELECT B
   SKIP
ENDDO
CLOSE DATA
MLINE = 99
MPAGE_LEN = 56
SELECT A
DO FOX_USE WITH "&MDBFLOC.BIL_BUY INDEX &MDBFLOC.BBUYNAME", .F.
SET CONSOLE OFF
IF FILE("C:\COMPINFO\PRINTERS.DBF")
   SET PRINT TO C:\COMPINFO\PRT_FILE.TXT
ELSE
   SET PRINT TO LPT3
ENDIF
SET DEVICE TO PRINT
SET PRINT ON

*** PRINT IN 12 CPI
?? chr(27) + '&k4S'

*** LETTER GOTHIC AND BOLDED PRINT
?? chr(27) + '(s4102T' + chr(27) + '(s3B' + chr(27) + '(s3B'

*** LETTER SIZE PAPER
?? CHR(27) + '&l2A'

*** PORTRAIT MODE
?? CHR(27) + '&l0O'

MTOT_SHIPS = 0
MTOT_DAYS = 0
DO WHILE .NOT. EOF()
   
   IF WORKSHIPS = 0 .OR. WORKDAYS = 0
      SKIP
      LOOP
   ENDIF
   MTOT_SHIPS = MTOT_SHIPS + WORKSHIPS
   MTOT_DAYS  = MTOT_DAYS + WORKDAYS
   
   IF MLINE > MPAGE_LEN
      IF MLINE <> 99
         EJECT
      ENDIF
      *** DO HEADERS HERE
      MLINE = 1
      @ MLINE,30 SAY 'MIDWEST FOOD & POULTRY, INC. ' + SPACE(15) + DTOC(DATE())
      MLINE = 2
      @ MLINE,30 SAY MCOMPANY
      MLINE = MLINE + 2
      IF MSALESMAN <> '**'
          @ MLINE,30 SAY 'SELECTED SALESPERSON: ' + MSALESMAN
          MLINE = MLINE + 1
      ENDIF
      @ MLINE,20 SAY 'CUSTOMER AGING DAYS BETWEEN ' + DTOC(MBEGIN) + ' - ' + DTOC(MEND)
      MLINE = MLINE + 2
      *** UNDERLINE ON
      ?? CHR(27) + '&d0D'

      @ MLINE,1 SAY 'CUSTOMER'                  
      @ MLINE,48 SAY 'AVG DAYS'
      @ MLINE,62 SAY 'NBR SHIPS'
      *** UNDERLINE OFF
      ?? CHR(27) + '&d@'
      *** @ MLINE,1 SAY REPLICATE('_',70)
      MLINE = MLINE + 2
   ENDIF
   @ MLINE,1 SAY NAME
   @ MLINE,50 SAY ROUND(WORKDAYS/WORKSHIPS,1) PICTURE '9999.9'
   @ MLINE,65 SAY WORKSHIPS PICTURE '99,999'
   MLINE = MLINE + 2
   SKIP
ENDDO
IF MLINE <> 99
   MLINE = MLINE + 1
   @ MLINE,1 SAY 'OVERALL TOTALS: '
   @ MLINE,50 SAY ROUND(MTOT_DAYS/MTOT_SHIPS,1) PICTURE '9999.9'
   @ MLINE,65 SAY MTOT_SHIPS PICTURE '99,999'
   EJECT
ENDIF

SET DEVICE TO SCREEN
SET PRINT OFF
SET PRINT TO
SET CONSOLE ON
IF MPRINTER3 <> 'DONOTPRINT'
   RUN &MPRINTIT3
ENDIF

CLOSE DATA
RETURN
